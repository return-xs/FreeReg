
### Conda 环境

```sh
conda env create -f environment.yaml
```

如果已经有环境，则使用

```sh
conda env update -f environment.yaml
```

- 可能会出现某些库装不上的情况，现将这些库从 yaml 里删除，后续单独安装。

> 若安装 pytorch-lightning 失败，请将 pip 版本降低至 24.0。 `pip install --upgrade pip==24.0`

### MinkowskiEngine

参考：

- https://blog.csdn.net/m0_60197472/article/details/125293739
- https://github.com/NVIDIA/MinkowskiEngine?tab=readme-ov-file#cuda-11x

针对 CUDA 11.X

```sh
pip install ninja

conda install openblas-devel -c anaconda

git clone https://github.com/NVIDIA/MinkowskiEngine.git

cd MinkowskiEngine

python setup.py install --blas_include_dirs=${CONDA_PREFIX}/include --blas=openblas
```

### open3d

若安装 open3d 失败，则直接 `pip install open3d` 即可。

### 预训练模型

StableDiffusion + ControlNet： 

```sh
# 没有文件夹就手动创建
cd tools/controlnet/models

wget -c --no-check-certificate "https://huggingface.co/stable-diffusion-v1-5/stable-diffusion-v1-5/resolve/main/v1-5-pruned-emaonly.ckpt?download=true"  -O v1-5-pruned-emaonly.ckpt

wget -c --no-check-certificate "https://drive.usercontent.google.com/download?id=1YSYXHZtg4Mvdh_twOK_FIc8kao3sA3z2&export=download&authuser=0&confirm=t&uuid=2a5b8c1e-06d6-4086-a9b8-cbd94dddd827&at=AKSUxGN_meExAuCmEiZtzBRQtWie%3A1761442006509" -O control_v11f1p_sd15_depth_ft.pth
```

深度估计器：

```sh
# 没有文件夹就手动创建
cd tools/zoe/models

wget -c --no-check-certificate "https://release-assets.githubusercontent.com/github-production-release-asset/565837677/62f7ce61-dac3-4c16-9768-dd6af06c12e6?sp=r&sv=2018-11-09&sr=b&spr=https&se=2025-10-26T02%3A40%3A00Z&rscd=attachment%3B+filename%3DZoeD_M12_N.pt&rsct=application%2Foctet-stream&skoid=96c2d410-5711-43a1-aedd-ab1947aa7ab0&sktid=398a6654-997b-47e9-b12b-9515b896b4de&skt=2025-10-26T01%3A39%3A41Z&ske=2025-10-26T02%3A40%3A00Z&sks=b&skv=2018-11-09&sig=pmUtryGVHEnDc0teWDRJHc5fybUP81vxX9pey2IjA38%3D&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmVsZWFzZS1hc3NldHMuZ2l0aHVidXNlcmNvbnRlbnQuY29tIiwia2V5Ijoia2V5MSIsImV4cCI6MTc2MTQ0NjQ0NywibmJmIjoxNzYxNDQyODQ3LCJwYXRoIjoicmVsZWFzZWFzc2V0cHJvZHVjdGlvbi5ibG9iLmNvcmUud2luZG93cy5uZXQifQ._nd1tE2NJF1QHs30GmI9nBb7CUa-dOmcf28FZqKFWJA&response-content-disposition=attachment%3B%20filename%3DZoeD_M12_N.pt&response-content-type=application%2Foctet-stream" -O ZoeD_M12_N.pt

wget -c --no-check-certificate  "https://release-assets.githubusercontent.com/github-production-release-asset/565837677/74a766f7-4650-4e10-84f9-b620d7c6ca2c?sp=r&sv=2018-11-09&sr=b&spr=https&se=2025-10-26T02%3A41%3A35Z&rscd=attachment%3B+filename%3DZoeD_M12_NK.pt&rsct=application%2Foctet-stream&skoid=96c2d410-5711-43a1-aedd-ab1947aa7ab0&sktid=398a6654-997b-47e9-b12b-9515b896b4de&skt=2025-10-26T01%3A41%3A08Z&ske=2025-10-26T02%3A41%3A35Z&sks=b&skv=2018-11-09&sig=NGWzDPLbVK8%2B7l2VE3oCw0TgicYcrZ8NYWVYgVRaewE%3D&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmVsZWFzZS1hc3NldHMuZ2l0aHVidXNlcmNvbnRlbnQuY29tIiwia2V5Ijoia2V5MSIsImV4cCI6MTc2MTQ0NzA2NSwibmJmIjoxNzYxNDQzNDY1LCJwYXRoIjoicmVsZWFzZWFzc2V0cHJvZHVjdGlvbi5ibG9iLmNvcmUud2luZG93cy5uZXQifQ.De8iD9EY1lWU6hqq-evhQn8B17xoseLXY1dqP-Vy8Tw&response-content-disposition=attachment%3B%20filename%3DZoeD_M12_NK.pt&response-content-type=application%2Foctet-stream" -O ZoeD_M12_NK.pt
```

FCGF 几何特征提取：

```sh
# 没有文件夹就手动创建
wget -c --no-check-certificate "https://drive.usercontent.google.com/download?id=1cLFlKC_novdwFbxk6dtLlqOUlmynV7jc&export=download&authuser=0" -O fcgf_indoor.pth

wget -c --no-check-certificate "https://drive.usercontent.google.com/download?id=1D6mKqzGqg9seeU3s2QJ7MEgHJPKxNo8F&export=download&authuser=0&confirm=t&uuid=b6f17508-51f0-4ef8-99be-1d9f8b94a272&at=AKSUxGOrFI1PjaRGTHj8vQlH3URJ%3A1761443874327" -O fcgf_outdoor.pth
```

### 数据集

将数据集放到 `data` 文件夹下。

3dmatch：

```sh
wget -c --no-check-certificate "https://drive.usercontent.google.com/download?id=1tSTlYFou6UEKR_UJa0Qm0Dy6foW4ubIs&export=download&authuser=0&confirm=t&uuid=eb6d61be-ecfa-43b9-9d2a-48f4467948ca&at=AKSUxGOw5ZsvzjmI_p1x-tFBHK9j%3A1761444061261" -O 3dmatch.zip

unzip 3dmatch.zip
```

scannet：

```sh
wget -c --no-check-certificate "https://drive.usercontent.google.com/download?id=1wSoPzuAIZ3DFU1Gk2wcREXQG3jd9PW7s&export=download&authuser=0&confirm=t&uuid=b67eadde-cf1e-4e8c-aa50-37658c0dc3e9&at=AKSUxGORh0dqI1JRWHBXLfCSMzd4%3A1761444182223" -O scannet.zip

unzip scannet.zip
```

kitti_dc：

```sh
wget -c --no-check-certificate "https://drive.usercontent.google.com/download?id=1c1TcUV2fMmXKK_vyZstVLD9J4-pCVCRu&export=download&authuser=0&confirm=t&uuid=8791b370-2a52-4f0b-8c66-1b5717286a0b&at=AKSUxGMNDF8qFinKXl6RukW_G8Bu%3A1761444254947" -O kitti_dc.zip

unzip kitti_dc.zip
```

### MiDas

```sh
git clone https://github.com/isl-org/MiDaS.git
```

然后修改路径，指向MiDas的hubconf.py文件：

```python
midas = torch.hub.load("/home/data/return/MiDaS", midas_model_type, pretrained=use_pretrained_midas, source='local') 
```

### 运行

```sh
python run.py --dataset 3dmatch --type dg
```

如果遇到 `drop_path` 相关报错报错，将 `timm` 版本改为 MiDas 项目的 timm 版本。

### 推送 github

```sh
git config --local user.email "varitaller@gmail.com"
git config --local user.name "return-xs"
```

